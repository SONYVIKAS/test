
public class Calculator {

    // Method to evaluate the expression
    public static double evaluate(String expression) {
        expression = expression.replace(" ", "");
        List<String> storage = new ArrayList<>();
        Stack<Integer> parensIndices = new Stack<>();
        Map<Character, List<Integer>> operators = new HashMap<>();
        operators.put('*', new ArrayList<>());
        operators.put('/', new ArrayList<>());
        operators.put('+', new ArrayList<>());
        operators.put('-', new ArrayList<>());

        for (int i = 0; i < expression.length(); i++) {
            char charAtI = expression.charAt(i);
            if (charAtI == '(') {
                parensIndices.push(i);
            } else if (charAtI == ')') {
                int start = parensIndices.pop() + 1;
                double total = calculate(expression.substring(start, i), operators);
                storage = storage.subList(0, start - 1);
                storage.add(String.valueOf(total));
            } else {
                storage.add(String.valueOf(charAtI));
            }

            if (operators.containsKey(charAtI)) {
                operators.get(charAtI).add(i);
            }
        }

        String stringExpression = String.join("", storage);
        return calculate(stringExpression, operators);
    }

    // Method to calculate the expression
    public static double calculate(String innerExpression, Map<Character, List<Integer>> operators) {
        double total = 0;
        operators.put('*', new ArrayList<>());
        operators.put('/', new ArrayList<>());
        operators.put('+', new ArrayList<>());
        operators.put('-', new ArrayList<>());
        String newExpr = innerExpression;

        for (int i = 0; i < innerExpression.length(); i++) {
            char charAtI = innerExpression.charAt(i);
            if (operators.containsKey(charAtI)) {
                operators.get(charAtI).add(i);
            }
        }

        while (!operators.get('*').isEmpty()) {
            int opIndex = operators.get('*').remove(operators.get('*').size() - 1);
            double prev = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex - 1)));
            double nxt = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex + 1)));
            total = prev * nxt;
            newExpr = newExpr.substring(0, opIndex - 1) + total + newExpr.substring(opIndex + 2);
        }

        while (!operators.get('/').isEmpty()) {
            int opIndex = operators.get('/').remove(operators.get('/').size() - 1);
            double prev = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex - 1)));
            double nxt = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex + 1)));
            total = prev / nxt;
            newExpr = newExpr.substring(0, opIndex - 1) + total + newExpr.substring(opIndex + 2);
        }

        while (!operators.get('-').isEmpty()) {
            int opIndex = operators.get('-').remove(operators.get('-').size() - 1);
            double prev = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex - 1)));
            double nxt = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex + 1)));
            total = prev - nxt;
            newExpr = newExpr.substring(0, opIndex - 1) + total + newExpr.substring(opIndex + 2);
        }

        while (!operators.get('+').isEmpty()) {
            int opIndex = operators.get('+').remove(operators.get('+').size() - 1);
            double prev = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex - 1)));
            double nxt = Double.parseDouble(String.valueOf(newExpr.charAt(opIndex + 1)));
            total = prev + nxt;
            newExpr = newExpr.substring(0, opIndex - 1) + total + newExpr.substring(opIndex + 2);
        }

        return total;
    }

    public static void main(String[] args) {
        System.out.println(evaluate("1 + 3 * 2"));  // Output: 7.0
        System.out.println(evaluate("(1 + 7) * 2"));  // Output: 16.0
        System.out.println(evaluate("4 * (1 + 7) - 3"));  // Output: 29.0
        System.out.println(evaluate("(4 - 7 - 1) * 3"));  // Output: -6.0
        System.out.println(evaluate("(1.2 + 1.3) * 2.5"));  // Output: 6.25
    }