import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.openqa.selenium.TimeoutException;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.List;
import java.util.concurrent.TimeUnit;

public class RunTest {

    // Configuration
    private static final String LOGIN_ID = "naveennoni2429@gmail.com";
    private static final String PASSWORD = "Github@0310";
    private static final String USER = "naveenjupeta";
    private static final String REPO_NAME = "codegenup";
    private static final String FOLDER_1 = "output";
    private static final String FOLDER_2 = "programs";
    private static final List<String> FILE_NAME = List.of("add_to_zero.java");

    private static WebDriver driver;
    private static WebDriverWait wait;
    private static final String SCREENS_DIR = "screenshots";

    public static void main(String[] args) {
        // Setup WebDriver
        System.setProperty("webdriver.chrome.driver", "path/to/chromedriver");
        driver = new ChromeDriver();
        driver.manage().window().maximize();
        wait = new WebDriverWait(driver, 10);

        // Create screenshots directory
        new File(SCREENS_DIR).mkdirs();

        try {
            // Step 1: Login
            driver.get("https://github.com/login");
            snap("login_page");
            wait.until(ExpectedConditions.presenceOfElementLocated(By.id("login_field"))).sendKeys(LOGIN_ID);
            driver.findElement(By.id("password")).sendKeys(PASSWORD);
            snap("before_submit");
            driver.findElement(By.name("commit")).click();

            // Step 1a: 2FA if prompted
            try {
                WebElement otp = wait.until(ExpectedConditions.presenceOfElementLocated(By.id("otp")));
                System.out.print("Enter 2FA code: ");
                String code = System.console().readLine();
                otp.sendKeys(code);
                driver.findElement(By.xpath("//button[contains(text(), 'Verify')]")).click();
                snap("2fa_done");
            } catch (TimeoutException ignored) {
            }

            wait.until(ExpectedConditions.presenceOfElementLocated(By.cssSelector("img.avatar-user")));
            System.out.println("Logged in");

            // Step 2: Open repository
            String repoUrl = String.format("https://github.com/%s/%s", USER, REPO_NAME);
            driver.get(repoUrl);
            snap("repo_home");
            TimeUnit.SECONDS.sleep(2);

            // Step 3: Navigate to src
            if (!clickItem(FOLDER_1, true)) {
                driver.get(String.format("%s/tree/main/%s", repoUrl, FOLDER_1));
                snap(FOLDER_1);
                TimeUnit.SECONDS.sleep(2);
            }

            // Step 4: Navigate nested path segments
            String currentUrl = driver.getCurrentUrl();
            for (String part : FOLDER_2.split("/")) {
                if (!clickItem(part, true)) {
                    driver.get(String.format("%s/%s", currentUrl, part));
                    snap(FOLDER_2);
                    TimeUnit.SECONDS.sleep(2);
                }
                currentUrl = driver.getCurrentUrl();
            }

            // Step 5: Download target files
            for (String fname : FILE_NAME) {
                if (!clickItem(fname, false)) {
                    driver.get(String.format("%s/%s", currentUrl, fname));
                    TimeUnit.SECONDS.sleep(2);
                }
                snap("view_" + fname);
                WebElement rawBtn = wait.until(ExpectedConditions.elementToBeClickable(By.id("raw-url")));
                driver.get(rawBtn.getAttribute("href"));
                String content = wait.until(ExpectedConditions.presenceOfElementLocated(By.tagName("pre"))).getText();
                new File("downloaded_files").mkdirs();
                String localPath = Paths.get("downloaded_files", fname).toString();
                try (FileWriter writer = new FileWriter(localPath)) {
                    writer.write(content);
                }
                snap("saved_" + fname);
                System.out.println("Saved " + fname);
                driver.get(currentUrl);
                snap(FILE_NAME.toString());
                TimeUnit.SECONDS.sleep(1);
            }

        } catch (Exception e) {
            System.out.println("Error occurred: " + e.getMessage());
            snap("error");
            try (FileWriter writer = new FileWriter("error_page_source.html")) {
                writer.write(driver.getPageSource());
            } catch (IOException ioException) {
                ioException.printStackTrace();
            }
            System.out.println("Page source saved to error_page_source.html");

        } finally {
            try {
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            driver.quit();
        }
    }

    private static void snap(String name) {
        File screenshot = ((ChromeDriver) driver).getScreenshotAs(OutputType.FILE);
        File destination = new File(SCREENS_DIR, name + ".png");
        screenshot.renameTo(destination);
        System.out.println("ðŸ“¸ " + destination.getPath());
    }

    private static boolean clickItem(String name, boolean isFolder) {
        try {
            By locator = By.xpath(String.format("//a[contains(@class,'js-navigation-open') and normalize-space(text())='%s']", name));
            WebElement el = wait.until(ExpectedConditions.elementToBeClickable(locator));
            ((ChromeDriver) driver).executeScript("arguments[0].scrollIntoView(true);", el);
            el.click();
            String target = isFolder ? "/tree/" : "/blob/";
            wait.until(d -> d.getCurrentUrl().contains(target) && d.getCurrentUrl().contains(name));
            snap("opened_" + name);
            System.out.println("Opened " + name);
            return true;
        } catch (Exception e) {
            return false;
        }
    }